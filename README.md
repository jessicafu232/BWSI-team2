# **Team Two UAS-SAR User Guide and Instructions**
Written by Team 2

# **Overview**
There are 4 main parts to operating our system. The classes.py file, master.py file, the Analyzer.py file, and Configuration Files. The Analyzer.py file takes raw data and implements backprojection and plots an image. The master.py file comunicates with the Emulator to generate and store raw scan information into a numpy file to be analyzed by Analyzer.py. Configuration Files define parameters for image formation and emulator configuration. 

When running pickle files that directly store raw information, define the pickle file within the Analyzer file, and run the Analyzer directly. When running the Emulator, first start the emulator (refer to the Emulator README) and then run master.py: This will automatically run and store raw scan data. Afterwards, run the Analyzer file. 

# **The Encoder and Decoder Classes**
Classes.py has two classes: `Encoder` and `Decoder`. These two classes are objects that are used to encode and send messages, as well as recieve and decode messages. The server socket is opened in this script to ensure that there is only one socket bound to the server at a single moment. 
* `Encoder` Class:
  * Converts the message from a dictionary into a bytearray, checking to ensure that the message content is suitable for the data type. 
  * Then sends to the server.
* `Decoder` Class:
  * Recieves message from the server and decodes it using bytearrays, converting the bytes into a readable dictionary.
  * Checks for errors in the `recieve_message(bufferSize)` function
    * Checks for dropped messages and status errors, and timeouts if waiting for message for more than 5 seconds.
* SIZES dictionary:
  * `SIZES` has all of the sizes of each variable type in bytes, and is used to encode and decode messages. Here is the dictionary, for reference:
    ```UINT8': 1,
    'UINT16': 2,
    'UINT32' : 4,
    'INT8': 1,
    'INT16': 2,
    'INT32' : 4,
    'CHAR[15]' : 15,
    'CHAR[32]' : 32
    ```
* STATUSES dictionary:
  * `STATUSES` has every status code for the messages recieved from the server and their meanings. Here is the dictionary, for reference:
    ```1: 'STATUS 1: GENERIC FAILURE',
    2: 'STATUS 2: WRONG OP MODE',
    3: 'STATUS 3: UNSUPPORTED VALUE',
    4: 'STATUS 4: INVALID DURING SLEEP',
    5: 'STATUS 5: WRONG MESSAGE SIZE',
    6: 'STATUS 6: NOT ENABLED',
    7: 'STATUS 7: WRONG BUFFER SIZE',
    8: 'STATUS 8: UNRECOGNIZED MESSAGE TYPE',
    542458195: 'INTERNAL ERROR CODE'
       ```

# **The Master file**
Master.py has a list of all the encoder and decoder objects, for every different type of message. It takes the config settings from a specified config file and uses those values in the encoding proccess. When trying to receive information from the emulator, make sure to run the correct configuration file.

If there is a dropped message or a BIT Error, the master.py code takes this into account and reboots/breaks accordingly. Otherwise, it runs a list of encoders and decoders through the classes.py file and takes all of the recieved scan data and saves it into a numpy array file (`array_as_numpy.npy`), located in the same directory as master.py. 

# **The Analyzer file**
The Analyzer.py file implements backprojection on raw data and plots an image. The Analyzer file can either take raw data from a pickle file (Marathon type), or can take raw data stored in a numpy file (`array_as_numpy.npy`) generated by the emulator. There are also certain arguments that this file can be run with (see [Running Analyzer.py](#running-analyzerpy)).

The Analyzer.py file will take the raw scan data and run certain calculations to assign each pixel in a pixel grid based on the analyzer configuration (see [Analyzer Type Values](#configuration-files---analyzer-type-values)). It also calculated the range resolution, cross range resolution, mininum amplitude, maximum amplitude, and time taken to render the image. The code also creates tick marks, evenly spaced based on the dimensions and offsets of the image set in the config file. It will always create ten total evenly-spaced tick marks, starting at the origin. Then it will plot this numpy array using matplotlib as an image alongside a colormap bar that demonstrates the highest and lowest amplitudes and how they are plotted. 

There are also a few other parameters that can affect image rendering, such as `contrast` and `skip`. See [Configuration Files](#configuration-files) for more information. The colormap can be changed at the very top of the file, using the `colormap` variable. A list of avaliable colormaps can be found [here](https://matplotlib.org/stable/tutorials/colors/colormaps.html).

Here is an example of an image that might be plotted by the Analyzer.py file:

![Image](https://cdn.discordapp.com/attachments/772273782001238030/1002627447054929992/unknown.png)

Here are all the images Team 2 has generated:
[Image Folder](https://drive.google.com/drive/folders/1MFG5UaaoMLEwFlsTefoemT-OyKQp0SNz?usp=sharing)

# **Configuration Files**
Configuration Files are a `.json` filetype containing a dictionary of information that is crucial to both Receive and Analyze Data. When forming images, modify these values to increase contrast, refocus the image, or increase resolution.
## Configuration Files - Emulator Type Values
Emulator Type Config Files are used when running the emulator to receive data, and thus contain more information on the emulator configuration. Make sure that both emulator.py and analyzer.py refer to the same file. Below is a short description of values to be stored and modified in the file.
1. **`Scan start` and `Scan end`** - Defines the Emulator Configuration Scan Start and End. These values help set the scope of the general range of the scan. See MRM API for more information. Scan Start should usually start at 0. 
2. **`Base Integration Index`** - Defines the Emulator Configuration Base Integration Index. See MRM API for more information.
3. **`Scan Amount`**  - Defines the number of Scans that the emulator will do. See MRM API for more information.
4. **`Transmit Gain`** - Defines the Emulator Configuration Transmit Gain. See MRM API for more information. Default value is 63. 
5. **`Scan Interval`** - Defines the Emulator Configuration Scan Interal. See MRM API for more information. 

## Configuration Files - Analyzer Type Values
Analyzer Type Config Files are used when directly running the Analyzer.py. Has less information compared to Emulator Type Config Files. Below is a short description of values to be stored and modified in the file.
1. **`X` and `Y` Values** - Defines the size of the image created. The image will be set to X meters by Y meters, where (0, 0) is the bottom left corner. The larger the X and Y values are, the more "zoomed out" the image will be.
2. **`X_RES` and `Y_RES` Values** - Defines the number of pixel the image will have. Forms a X_RES by Y_RES pixel image. Increasing these values increase resolution. 
3. **`X_OFFSET` and `Y_OFFSET` Values** - Defines the shift of the Axis in the image. The X_OFFSET value will shift the X-Axis by X_OFFSET meters to the left. The Y_OFFSET value will shift the Y-Axis Y_OFFSET meters down. These values help focus on the image. 
4. **`Skip`** - Defines the interval of scans that will be skipped over. 
5. **`Contrast` Value** - Increasing this value increases the contrast by taking all of the amplitudes in the pixel and raising it to the Contrast Value. A Contrast Value of 1 is the default Contrast. 

# Running Analyzer.py
The analyzer program has a few arguments/parameters for analyzing data.

`--datafile`, `-df`
* Location of a datafile to analyze the data of (i.e. `../team2/array_to_numpy.npy`)

`--config`, `-c`
* Location of a config file (i.e. `../marathon_0_config.json`)

`--mode`, `-em`
* Whether or not the file is run through the emulator.
  * Default is `true`, can be set to `true` or `false`

# Procedure for running the program!
Specifically for the final event. Kind of a tutorial just to make sure we don't forget anything :)

## Part 1: Image Marathon
1. Download datafile (`marathon_#.pkl`), where # is the num of file
2. Create config
    * Edit config file at the top of Analyzer.py
    * Edit the file to analyze at the top of Analyzer.py
    * Edit the file that the `potentials` array is saved into (AKA the `fileName` variable near the bottom of the code), the name in the format of:
      * `marathon_#_img.pkl`
2. Run the file through Analyzer.py. Since it doesn't run through the emulator, run like the following: `python Analyzer.py -em false`
3. Check image--zoom out, edit res, etc. if necessary,
4. Rinse and repeat until the image is properly rendered.
5. Save the image as a .jpg file, the name in the format of:
  * `marathon_#_thumbnail.jpg`
6. Go into the [Google Drive Folder](https://drive.google.com/drive/folders/1QcMBxsw45c9I8Y6A0zbhN3zqhf3OZ8Xd?usp=sharing) for the submissions and drop in two files:
  * The final `marathon_#_img.pkl` file
  * The final `marathon_#_thumbnail.jpg` image
7. Move on :)

## Part 2: Hide and Seek
1. Download datafile (`hide_and_seek_#.pkl`), where # is the num of file
2. Create config
    * Edit config file at the top of master.py and Analyzer.py
    * Edit the file to run through the emulator at the top of master.py
    * Edit the file to analyze at the top of Analyzer.py
    * Edit the file that the `potentials` array is saved into (AKA the `fileName` variable near the bottom of the code), the name in the format of:
      * `hide_and_seek_#_img.pkl`
 3. Run the emulator.py file, using `-dm offline -od ../../team2/hide_and_seek_#.pkl --op_mode real`
 4. Run the Analyzer.py file with the normal settings
 5. Save the image as a .jpg file, the name in the format of:
   * `hide_and_seek_#_thumbnail.jpg`
 6. Go into the [Google Drive Folder](https://drive.google.com/drive/folders/1QcMBxsw45c9I8Y6A0zbhN3zqhf3OZ8Xd?usp=sharing) for the submissions and drop in two files:
  * The final `hide_and_seek_#_img.pkl` file
  * The final `hide_and_seek_#_thumbnail.jpg` image
7. Move on :) 


***

# Team 2: 
Ty  
Tanush  
Jessica  
Ellie  
Felix  
